<!doctype html>

<title>Murmur online editor</title>
<meta charset="utf-8"/>
<link rel=stylesheet href="../../doc/docs.css">

<link rel="stylesheet" href="../../lib/codemirror.css">
<link rel="stylesheet" href="../../lib/fontawesome-all.min.css">
<script src="../../lib/fontawesome-all.min.js"></script>
<script src="../../lib/codemirror.js"></script>
<script src="../../addon/edit/matchbrackets.js"></script>
<script src="python.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<style type="text/css">
  .CodeMirror {border-top: 1px solid black; border-bottom: 1px solid black;}
  body { padding: 20px; }

  .info {color: white;}
  .error { color: red; }

  #console {
    background: black;width:100%;padding-left: 40px;
  }

  #loader {
    display: none;
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #3498db;
    width: 120px;
    height: 120px;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
  }

  @-webkit-keyframes spin {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #status {
    display: none;
  }

</style>


<body>
  <div id="loader"></div>

  <h2>Murmur: Program your inbox!</h2>
  <div id="login_window">
    Email address: <input id="username" type="text"/>
    Password: <input id="password" type="password"/>
    <button onclick="authenticate()">Log in</button>
    <span id="auth-msg"></span>
  </div>

  <div id="status">
    Inbox engine status: <i class="fas fa-cog fa-3x"></i>
    <button onclick="logout()">Log out</button>
    <!-- <span id="auth-msg"></span> -->
  </div>

      <div style="padding-top:  50px;"><textarea id="code" name="code">
def notifyWhen(incoming):
    # Notify me every 5 emails arrive 
    if incoming.getCount() >= 5 or any(("karger" in s) or ("axz" in s) for s in incoming.getSender()):
        return True

    return False

def action():
    send("to_addr@mit.edu", "Murmur: Full inbox", "Check your inbox")
    
queue(notifyWhen, action, ["INBOX", "folder1"])
  </textarea>
  <button id="submit" onclick="submitCommand()" disabled>Submit</button>
  </div>

  <div id="console" class="info"></div>

  <script>
    var config = {
      apiKey: "AIzaSyCOFXECn39JmWeykyPVv2fU6GClWNJeUek",
      authDomain: "murmur-183618.firebaseapp.com",
      databaseURL: "https://murmur-183618.firebaseio.com",
      projectId: "murmur-183618",
      storageBucket: "murmur-183618.appspot.com",
      messagingSenderId: "1035128514395"
    };
    firebase.initializeApp(config);

    var uid = "";
    var auth = false, execute = false, first = true;

    function authenticate() {
      showLoader(true);

      uid = hashCode(document.getElementById("username").value)
      var playersRef = firebase.database().ref("users/" + uid);
        // users/2017-3-6

      playersRef.set({
              "type": "auth",
              "username": document.getElementById("username").value,
              "password": document.getElementById("password").value
          },
          function(response) {
            if(response)
              console.log("Firebase: Error at submiting command " + response);
            else {
              // successfully submitted, show a msg to user
              installListener();
            }
          });
    }

    function login_success() {
      $("#login_window").hide();
      $("#status").show();

      showLoader(false);
    }

    function logout() {
      $("#login_window").show();
      $("#status").hide();
    }

    function showLoader(show) {
      if(show)
        $("#loader").show();
      else 
        $("#loader").hide();
    }

    function spinStatusCog(spin) {
      if(spin)
        $("svg.fa-cog").addClass("fa-spin");
      else 
        $("svg.fa-cog").removeClass("fa-spin");
    }

    function installListener() {
      var msgRef = firebase.database().ref("messages/" + uid);
      var startKey = msgRef.push().key;

        msgRef.orderByKey().startAt(startKey).on('child_added', function(snapshot) {
          console.log("New message: ");
          // console.log(snapshot.val());
          if(snapshot.val()["auth"]) {
            if(snapshot.val()["code"] == 200){
              $("#auth-msg").text(snapshot.val()["auth"]);
              $("#auth-msg").removeClass("error");
              
              $("button").prop("disabled",false);
              auth = true;

              
              myVar = setTimeout(login_success, 4000);
            }
            else {
              $("#auth-msg").text(snapshot.val()["auth"]);

              $("#auth-msg").addClass("error");

              showLoader(false);
            }

            
          }
          else { // after auth success
            if(!auth || !execute) return;

            if(snapshot.val()["type"] == "error")  {
              $("#console").text(snapshot.val()["content"]);
              $("#console").addClass("error").removeClass('info');
            }
            else {
              $("#console").text(snapshot.val()["content"]);
              $("#console").addClass("info").removeClass("error");
            }
          }

      });

      var ruuningRef = firebase.database().ref("running/" + uid);
      ruuningRef.on('value', function(snapshot) {
        if(snapshot.val()) spinStatusCog(true);
        else spinStatusCog(false);
      });
    }

    function hashCode(str){
      var hash = 0;
      if (str.length == 0) return hash;
      for (i = 0; i < str.length; i++) {
          char = str.charCodeAt(i);
          hash = ((hash<<5)-hash)+char;
          hash = hash & hash; // Convert to 32bit integer
      }
      return hash;
    }

    function submitCommand() {
      if(uid == "") {
        alert("Log in first!");
        return;
      }

      // Clean up previous execution result
      $("#console").text("")

      var playersRef = firebase.database().ref("users/" + uid);
        // users/2017-3-6

      playersRef.push({
              "type": "cmd",
              "uid": uid.toString(),
              "content": editor.getValue()
          },
          function(response) {
            execute = true;
            if(response)
              console.log("Firebase: Error at submiting command " + response);
            else {
              // successfully submitted, show a msg to user
            }
          });
    }

    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: {name: "python",
             version: 3,
             singleLineStringErrors: false},
      lineNumbers: true,
      indentUnit: 4,
      matchBrackets: true
    });
  </script>
</body>