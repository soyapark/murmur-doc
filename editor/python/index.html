<!doctype html>

<title>Murmur online editor</title>
<meta charset="utf-8"/>
<link rel=stylesheet href="../../doc/docs.css">

<link rel="stylesheet" href="../../lib/codemirror.css">
<link rel="stylesheet" href="../../lib/fontawesome-all.min.css">
<script src="../../lib/fontawesome-all.min.js"></script>
<script src="../../lib/codemirror.js"></script>
<script src="../../addon/edit/matchbrackets.js"></script>
<script src="python.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
<script src="conf.js"></script>

<style type="text/css">
  .CodeMirror {border-top: 1px solid black; border-bottom: 1px solid black;}

  .info {color: white;}
  .error { color: red; }

  .header {
    padding: 10px 16px;
    background: #555;
    color: #f1f1f1;
  }

  .content {
    padding: 16px;
    padding-top: 30px;
  }

  .sticky {
    position: fixed;
    top: 0;
    width: 100%;
  }

  .sticky + .content {
    padding-top: 70px;
  }

  #console {
    background: black;width:100%;padding-left: 40px;
  }

  #loader {
    display: none;
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #3498db;
    width: 120px;
    height: 120px;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
  }

  @-webkit-keyframes spin {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #status {
    display: none;
  }

  .CodeMirror {
    height: 500px;
  }
</style>


<body>
  <div id="loader"></div>

  <!-- <div class="header sticky" id="myHeader" style="background-color: Tomato;">
    <span>Murmur is currently shut down. Let the <a href="mailto:sbhappylee@gmail.com">admin</a> know it is not working!</span>
  </div> -->

  <div class="content">
    <h2>Murmur: Program your inbox!</h2>
    <div id="login_window">
      Email address: <input id="username" type="text"/>
      Password: <input id="password" type="password"/>
      <button onclick="authenticate()">Log in</button>
      <span id="auth-msg"></span>
      <br/><br/>
      <p>* This project is currently undergoing development. <br/>
        We might ask you log in again and again to Murmur whenever we reboot Murmur. <br/> 
        This is due we don't store your password nor email contents but your email source code for user-behavior analysis purpose.</p>
    </div>

    <div id="status">
      Inbox engine status: 
      <div class="fa-3x">
        <span class="fa-layers fa-fw">
          <i class="fas fa-cog"></i>
          <span class="fa-layers-counter idle-mark" style="background:Tomato">IDLE</span>
        </span>
      </div>
      <button onclick="logout()">Log out</button>
      <!-- <span id="auth-msg"></span> -->
    </div>

        <div style="padding-top:  50px;">
          <textarea id="code" name="code">
def doAction(newEmail):
    if "free food" in newEmail.getSubject()[0]:
        send("my_colleague@mit.edu", "Free food is here!", "\n".join(newEmail.getSubject()))

onArrive(doAction, ["INBOX"])
    </textarea>
    <button id="submit" onclick="submitCommand()" disabled>Submit</button>
    </div>

    <div id="console" class="info"></div>
  </div>
  <script>
    

    var uid = "";
    var auth = false, execute = false, first = true;

    var runningRef = firebase.database().ref("running/");
    runningRef.on('value', function(snapshot) {
        if(!snapshot.val()) {
          $('<div class="header sticky" id="myHeader" style="background-color: Tomato;"><span>Murmur is currently shut down. Let the <a href="mailto:sbhappylee@gmail.com">admin</a> know it is not working!</span></div>').prependTo('body');
        }
        else {
          $('.header').remove();
        }
      });
    

    function authenticate() {
      showLoader(true);

      uid = hashCode(document.getElementById("username").value)
      var playersRef = firebase.database().ref("users/" + uid);
        // users/2017-3-6

      playersRef.push({
              "username": document.getElementById("username").value,
              "password": document.getElementById("password").value,
              "type": "auth"
          },
          function(response) {
            if(response)
              console.log("Firebase: Error at submiting command " + response);
            else {
              // successfully submitted, show a msg to user
              installListener();
            }
          });
    }

    function login_success() {
      $("#login_window").hide();
      $("#status").show();

      showLoader(false);
    }

    function logout() {
      submitCommand("logout()");
      $("#login_window").show();
      $("#status").hide();
      window.location.reload(true);
    }

    function showLoader(show) {
      if(show)
        $("#loader").show();
      else 
        $("#loader").hide();
    }

    function spinStatusCog(spin) {
      if(spin)
        $("svg.fa-cog").addClass("fa-spin");
      else 
        $("svg.fa-cog").removeClass("fa-spin");
    }

    function installListener() {
      var msgRef = firebase.database().ref("messages/" + uid);
      var startKey = msgRef.push().key;

        msgRef.orderByKey().startAt(startKey).on('child_added', function(snapshot) {
          console.log("New message: ");
          // console.log(snapshot.val());
          if(snapshot.val()["auth"]) {
            if(snapshot.val()["code"] == 200){
              $("#auth-msg").text(snapshot.val()["auth"]);
              $("#auth-msg").removeClass("error");
              
              $("button").prop("disabled",false);
              auth = true;

              login_success()
              // myVar = setTimeout(login_success, 4000);
            }
            else {
              $("#auth-msg").text(snapshot.val()["auth"]);

              $("#auth-msg").addClass("error");

              showLoader(false);
            }

            
          }
          else { // after auth success
            if(!auth || !execute) return;
            var currentdate = new Date(); 
            var datetime = currentdate.getDate() + "/"
                        + (currentdate.getMonth()+1)  + "/" 
                        + currentdate.getFullYear() + " @ "  
                        + currentdate.getHours() + ":"  
                        + currentdate.getMinutes() + ":" 
                        + currentdate.getSeconds()
                        + " | ";

            if(snapshot.val()["type"] == "error")  {
              $( "<p>" + datetime + snapshot.val()["content"] + "</p>" ).appendTo( "#console" )
                .addClass("error");
            }
            else {
              $( "<p>" + datetime + snapshot.val()["content"] + "</p>" ).appendTo( "#console" )
                .addClass("info");
            }
          }

      });

      var ruuningRef = firebase.database().ref("running/" + uid);
      ruuningRef.on('value', function(snapshot) {
        if(snapshot.val()) {
          spinStatusCog(true);
          editor.setValue(snapshot.val()) 
          $(".idle-mark").hide();
        }
        else {
          spinStatusCog(false);
          $(".idle-mark").show();
        }
      });
    }

    function hashCode(str){
      var hash = 0;
      if (str.length == 0) return hash;
      for (i = 0; i < str.length; i++) {
          char = str.charCodeAt(i);
          hash = ((hash<<5)-hash)+char;
          hash = hash & hash; // Convert to 32bit integer
      }
      return hash;
    }

    function submitCommand(cmd) {
      if(uid == "") {
        alert("Log in first!");
        return;
      }

      // Clean up previous execution result
      $("#console").text("")

      var playersRef = firebase.database().ref("users/" + uid);
        // users/2017-3-6

      playersRef.push({
              "type": "cmd",
              "uid": uid.toString(),
              "content": cmd ? cmd: editor.getValue()
          },
          function(response) {
            execute = true;
            if(response)
              console.log("Firebase: Error at submiting command " + response);
            else {
              // successfully submitted, show a msg to user
            }
          });
    }

    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: {name: "python",
             version: 3,
             singleLineStringErrors: false},
      lineNumbers: true,
      indentUnit: 4,
      matchBrackets: true
    });
  </script>
</body>